#---------Bibliotecas---------#

import socket
from tqdm import tqdm
import time

#---------Padroes---------#

port_pattern = [21, 22, 25, 53, 80, 110, 135, 136, 137, 138, 139, 143, 443, 3306, 3389, 8080]
all_port = range(65535)

a = 0

pp_o = []
pp_c = []
ap = []

#---------CLASS---------#

class PORTSCAN:
    def __init__(self, ip, port, s):
        self.s = s
        self.ip = ip
        self.port = port
    pass
    
    def prun(self):

        target = self.ip
        ports = self.port

        if(ports == "pattern"):
            global port_pattern

            print("\nINICIANDO ESCANEAMENTO DAS PORTAS PADRÕES\n")

            for tport in tqdm(port_pattern):
                client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                client.settimeout(0.05)
                code = client.connect_ex((target, tport))
                codet = str(code)
                if(codet == '0'):
                    pp_o.append(tport)
                else:
                    pp_c.append(tport)
        else:
            global all_port

            print("\nINICIANDO ESCANEAMENTO DE TODAS AS PORTAS\n")

            for tport in tqdm(all_port):
                client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                client.settimeout(0.05)
                code = client.connect_ex((target, tport))
                codet = str(code)
                if(codet == '0'):
                    ap.append(tport)

    pass

    def re_p(self):
        global pp_o
        global pp_c

        print("\n#######################################################\n")
        print("                Relatório de PortScan                      ")
        print("\n - Portas abertas:\n")
        for p in pp_o:
            print('PORTA: {} <----> '.format(p) + '\033[32m' + 'ABERTA' + '\033[0;0m\n')
        print("\n - Portas fechadas:\n")
        for p in pp_c:
            print('PORTA: {} <----> '.format(p) + '\033[31m' + 'FECHADA' + '\033[0;0m\n')
    pass

    def re_a(self):
        global ap

        print("\n#######################################################\n")
        print("                Relatório de PortScan                      ")
        print("\n - Portas abertas:\n")
        for p in ap:
            print('PORTA: {} <----> '.format(p) + '\033[32m' + 'ABERTA' + '\033[0;0m\n')
    pass

    def save(self):
        global pp_o
        global pp_c
        global ap

        save = self.s

        if(save == 'sim' or save == 'Sim'):
            if(self.port == 'pattern'):
                sn = (f'saves/pattern_{self.ip}.txt')
                arq = open(sn, 'a')
                arq.write('\n#######################################################\n\n')
                arq.write("                Relatório de PortScan                      ")
                arq.write("\n\n - Portas abertas:\n\n")
                for i in pp_o:
                    arq.write(f'PORTA: {i} <----> ABERTA\n')
                arq.write("\n - Portas fechadas:\n\n")
                for i in pp_c:
                    arq.write(f'PORTA: {i} <----> FECHADA\n')
                arq.close()
                print(f' Relatório Escrito Concluido.\n Foi salvo como: {sn}')
            else:
                sn = (f'saves/all_{self.ip}.txt')
                arq = open(sn, 'a')
                arq.write('\n#######################################################\n\n')
                arq.write("                Relatório de PortScan                      ")
                arq.write("\n\n - Portas abertas:\n\n")
                for i in ap:
                    arq.write(f'PORTA: {i} <----> ABERTA\n')
                arq.close()
                print(f' Relatório Escrito Concluido.\n Foi salvo em: {sn}')
    pass